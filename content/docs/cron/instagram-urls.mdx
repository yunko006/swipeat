---
title: Refresh des URLs Instagram
description: Syst√®me automatique pour maintenir les URLs CDN Instagram √† jour
---

## Le probl√®me

Les URLs des vid√©os et images Instagram CDN expirent apr√®s un certain temps. Sans refresh, les recettes Instagram deviennent inutilisables car les vid√©os ne se chargent plus.

## La solution

Swipeat utilise **deux syst√®mes compl√©mentaires** pour garantir que les URLs sont toujours valides:

### 1. Cron job automatique (proactif)

Un cron job Vercel s'ex√©cute **toutes les 12 heures** et refresh automatiquement toutes les URLs qui vont expirer dans les prochaines 24 heures.

**Fichier de configuration:** `vercel.json`
```json
{
  "crons": [
    {
      "path": "/api/cron/refresh-expiring-urls",
      "schedule": "0 */12 * * *"
    }
  ]
}
```

**Comment √ßa marche:**
1. Le cron cherche toutes les recettes Instagram dont les URLs expirent bient√¥t
2. Pour chaque recette, il appelle l'API Instagram pour obtenir de nouvelles URLs
3. Il met √† jour la base de donn√©es avec les nouvelles URLs et leurs dates d'expiration
4. Un d√©lai de 500ms entre chaque refresh √©vite le rate limiting

**Endpoint:** `GET /api/cron/refresh-expiring-urls`

### 2. Refresh √† la demande (r√©actif)

Si une URL expire entre deux ex√©cutions du cron (rare), le composant `BentoLetmecook` d√©tecte automatiquement l'expiration et refresh l'URL avant d'afficher la vid√©o.

**Comment √ßa marche:**
1. Quand l'utilisateur ouvre une recette, le composant v√©rifie la date d'expiration
2. Si l'URL expire dans moins d'1 heure, un refresh automatique est d√©clench√©
3. Un overlay de chargement s'affiche pendant le refresh
4. L'utilisateur peut ensuite regarder la vid√©o normalement

**Endpoint:** `POST /api/instagram/refresh`
```json
{
  "recipeId": "uuid-de-la-recette"
}
```

## Configuration Vercel

### 1. Ajouter le secret cron

Dans ton dashboard Vercel:
1. Va dans **Settings** ‚Üí **Environment Variables**
2. Ajoute `CRON_SECRET` avec une valeur al√©atoire s√©curis√©e
3. Pour g√©n√©rer un secret: `openssl rand -base64 32`

### 2. D√©ployer

Une fois d√©ploy√©, Vercel va automatiquement:
- Configurer le cron job selon `vercel.json`
- Ajouter le header `Authorization: Bearer <CRON_SECRET>` lors des appels cron
- Ex√©cuter le cron toutes les 12 heures

### 3. Monitoring

Les logs sont disponibles dans:
- **Deployments** ‚Üí **Functions** ‚Üí **Logs**

Tu verras:
- üîÑ D√©but du cron job
- Nombre de recettes trouv√©es
- ‚úÖ Recettes refresh√©es avec succ√®s
- ‚ùå Erreurs √©ventuelles

## Dates d'expiration

Les dates d'expiration sont stock√©es dans la base de donn√©es:

```typescript
// Schema recipes table
videoUrlExpiresAt: timestamp("video_url_expires_at", { withTimezone: true })
imageUrlExpiresAt: timestamp("image_url_expires_at", { withTimezone: true })
```

Elles sont automatiquement pars√©es depuis le param√®tre `oe=` des URLs Instagram (timestamp hexad√©cimal).

## Tests

### Tester le cron endpoint localement

```bash
curl -X GET http://localhost:3000/api/cron/refresh-expiring-urls \
  -H "Authorization: Bearer TON_CRON_SECRET"
```

### Tester le refresh manuel

```bash
curl -X POST http://localhost:3000/api/instagram/refresh \
  -H "Content-Type: application/json" \
  -d '{"recipeId":"uuid-de-ta-recette"}'
```
